{% extends "base.html" %}

{% block title %}Chapter {{ content.chapter_number }} – {{ content.title }}{% endblock %}

{% block head_extra %}
<style>
  /* ── Paginated Comic Viewer ── */

  /* Viewer shell */
  .cv-shell {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
    width: 100%;
    padding: 0 0 2rem;
  }

  /* Header bar */
  .cv-header {
    width: 100%;
    max-width: 900px;
    text-align: center;
    padding: 1.5rem 1rem 1rem;
  }

  .cv-title {
    font-family: var(--font-display);
    font-size: clamp(1.4rem, 4vw, 2.2rem);
    font-weight: 600;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    text-shadow: 0 0 10px rgba(168, 0, 0, 0.4);
    margin-bottom: 0.3rem;
  }

  .cv-meta {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-style: italic;
  }

  /* Alerts */
  .cv-alert {
    width: 100%;
    max-width: 900px;
    padding: 0.75rem 1rem;
    border-radius: 4px;
    font-size: 0.88rem;
    margin-bottom: 0.5rem;
  }

  .cv-alert-info {
    background: rgba(33, 150, 243, 0.1);
    color: #90caf9;
    border: 1px solid #2196f3;
  }

  .cv-alert-viewed {
    background: var(--accent-red-dim);
    border: 1px solid var(--border-blood);
    color: var(--text-dim);
  }

  /* ── Viewport ── */
  .cv-viewport {
    position: relative;
    width: 100%;
    max-width: 900px;
    background: #000;
    border: 1px solid var(--border-subtle);
    border-radius: 6px;
    overflow: hidden;
    /* touch-action set dynamically by JS:
       pan-y at scale=1 (allows page scroll), none when zoomed */
    touch-action: pan-y;
    cursor: default;
    user-select: none;
    -webkit-user-select: none;
  }

  /* On mobile the viewport must NOT clip vertically —
     let the image show at its natural height */
  @media (max-width: 768px) {
    .cv-viewport {
      overflow: visible;
      border-radius: 6px;
    }

    .cv-panel {
      border-radius: 6px;
      overflow: hidden;
    }
  }

  .cv-panel {
    display: none;
    width: 100%;
  }

  .cv-panel.active {
    display: block;
  }

  /* Canvas: normal flow so the image height determines viewport height */
  .cv-canvas {
    display: block;
    width: 100%;
    transform-origin: 0 0;
    will-change: transform;
  }

  .cv-img {
    display: block;
    width: 100%;
    height: auto;
    -webkit-user-drag: none;
    pointer-events: none;
  }

  /* ── Toolbar ── */
  .cv-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    max-width: 900px;
    padding: 0.45rem 0.75rem;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--border-subtle);
    border-top: none;
    border-radius: 0 0 6px 6px;
    gap: 0.5rem;
  }

  .cv-zoom-label {
    font-size: 0.78rem;
    color: var(--text-muted);
    min-width: 3.5ch;
    text-align: left;
    font-variant-numeric: tabular-nums;
  }

  .cv-usage-hint {
    font-size: 0.7rem;
    color: var(--text-muted);
    opacity: 0.55;
    text-align: center;
    font-style: italic;
    flex: 1;
  }

  .cv-page-counter {
    font-family: var(--font-display);
    font-size: 1rem;
    color: var(--text-dim);
    white-space: nowrap;
    text-align: right;
  }

  /* ── Navigation row ── */
  .cv-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    max-width: 900px;
    padding: 0.75rem 0;
    gap: 1rem;
  }

  .cv-nav-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    min-height: 48px;
    /* WCAG touch target */
    padding: 0.6rem 1.5rem;
    font-family: var(--font-display);
    font-size: clamp(0.9rem, 3vw, 1.1rem);
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-primary);
    background: var(--bg-card);
    border: 1px solid var(--border-blood);
    border-radius: 4px;
    cursor: pointer;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    transition: background 0.25s, box-shadow 0.25s, color 0.25s;
    user-select: none;
  }

  .cv-nav-btn:hover,
  .cv-nav-btn:active {
    background: var(--accent-red);
    border-color: var(--accent-red);
    color: #fff;
    box-shadow: 0 0 16px var(--glow-red);
  }

  .cv-nav-btn:disabled {
    opacity: 0.3;
    pointer-events: none;
  }

  /* Progress bar */
  .cv-progress-wrap {
    flex: 1;
    height: 4px;
    background: var(--border-subtle);
    border-radius: 2px;
    overflow: hidden;
  }

  .cv-progress-bar {
    height: 100%;
    background: var(--accent-red);
    transition: width 0.3s ease;
    border-radius: 2px;
  }

  /* ── Submit section ── */
  .cv-submit {
    width: 100%;
    max-width: 900px;
    text-align: center;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-subtle);
    margin-top: 1rem;
  }

  /* ── Mobile tweaks ── */
  @media (max-width: 600px) {

    /* No max-height: let the full comic panel image be visible */
    .cv-nav-btn {
      padding: 0.6rem 1rem;
    }

    .cv-toolbar {
      padding: 0.5rem 0.5rem;
    }
  }

  @media (max-width: 380px) {
    .cv-nav-btn {
      font-size: 0.82rem;
      padding: 0.55rem 0.75rem;
    }

    .cv-btn {
      min-width: 36px;
      min-height: 36px;
      font-size: 1rem;
    }
  }

  /* ── Last-page hint banner ── */
  .cv-hint-banner {
    display: none;
    text-align: center;
    font-family: var(--font-display);
    font-size: 0.76rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--accent-red);
    border-top: 1px solid rgba(180, 0, 0, 0.25);
    border-bottom: 1px solid rgba(180, 0, 0, 0.25);
    padding: 0.55rem 1rem;
    margin: 0.75rem auto 0;
    max-width: 900px;
    width: 100%;
    animation: hint-slide 0.7s ease forwards;
  }

  .cv-hint-icon {
    opacity: 0.45;
    font-size: 0.55rem;
    vertical-align: middle;
    margin: 0 0.5rem;
  }

  @keyframes hint-slide {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Pulse glow on seal button when first unlocked */
  @keyframes seal-pulse {

    0%,
    100% {
      box-shadow: none;
    }

    50% {
      box-shadow: 0 0 22px rgba(180, 0, 0, 0.75);
    }
  }

  .btn-completed.seal-ready {
    animation: seal-pulse 1.2s ease 3;
  }

  /* ── Video player ── */
  .cv-video-wrap {
    width: 100%;
    max-width: 900px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.6rem;
  }

  .cv-video {
    width: 100%;
    aspect-ratio: 16 / 9;
    border: 1px solid var(--border-blood);
    border-radius: 6px;
    background: #000;
    display: block;
  }

  .cv-video-hint {
    font-size: 0.78rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-muted);
    opacity: 0.7;
    text-align: center;
    font-style: italic;
    margin: 0;
    transition: color 0.5s;
  }

  .cv-video-hint.done {
    color: var(--accent-red);
    opacity: 1;
    font-style: normal;
  }
</style>
{% endblock %}

{% block content %}
<div class="cv-shell" id="cv-shell">

  {# ── Header ── #}
  <div class="cv-header">
    <h1 class="cv-title">{{ content.title }}</h1>
    <p class="cv-meta">{% if is_video %}Watch the full recording to seal this case file.{% else %}Examine each piece of
      evidence carefully.{% endif %}</p>
  </div>

  {# ── Alerts ── #}
  {% if is_preview %}
  <div class="cv-alert cv-alert-info">
    <strong>Admin Preview Mode</strong> — Attempt logging disabled.
  </div>
  {% endif %}


  {# ─────────────────────────── VIDEO MODE ─────────────────────────── #}
  {% if is_video %}

  <div class="cv-video-wrap" id="cv-video-wrap">
    {% if video_type == "direct" %}
    <video id="cv-video-el" class="cv-video" controls controlsList="nodownload" preload="metadata" playsinline>
      <source src="{{ video_url }}" />
      Your browser does not support the video tag.
    </video>
    {% else %}
    <iframe id="cv-video-iframe" class="cv-video" src="{{ video_url }}" allow="autoplay; fullscreen; picture-in-picture"
      allowfullscreen frameborder="0" title="Chapter {{ content.chapter_number }} Video">
    </iframe>
    {% endif %}
    <p class="cv-video-hint" id="cv-video-hint">
      ▶ Watch the full recording to seal this case file.
    </p>
  </div>

  {% endif %}
  {# ──────────────────────────── PANELS MODE ──────────────────────────── #}
  {% if panels and not is_video %}

  {# ── Viewport ── #}
  <div class="cv-viewport" id="cv-viewport" role="region" aria-label="Evidence viewer">
    {% for panel_img in panels %}
    <div class="cv-panel {% if loop.first %}active{% endif %}" data-index="{{ loop.index0 }}" role="img"
      aria-label="Evidence photo {{ loop.index }} of {{ panels|length }}">
      <div class="cv-canvas">
        <img class="cv-img" src="{{ panel_img }}" alt="Evidence photo {{ loop.index }}"
          loading="{% if loop.first %}eager{% else %}lazy{% endif %}" draggable="false" />
      </div>
    </div>
    {% endfor %}
  </div>

  {# ── Toolbar: zoom% + hint + page counter ── #}
  <div class="cv-toolbar">
    <span class="cv-zoom-label" id="cv-zoom-label">100%</span>
    <span class="cv-usage-hint">Scroll / pinch to zoom &middot; Drag to pan &middot; Double-tap to reset</span>
    <span class="cv-page-counter" id="cv-page-counter" aria-live="polite">
      Page 1 / {{ panels|length }}
    </span>
  </div>

  {# ── Navigation row ── #}
  <div class="cv-nav">
    <button class="cv-nav-btn" id="cv-prev" aria-label="Previous page" disabled>← Prev</button>
    <div class="cv-progress-wrap" role="progressbar" aria-valuenow="1" aria-valuemin="1"
      aria-valuemax="{{ panels|length }}" id="cv-progress-wrap">
      <div class="cv-progress-bar" id="cv-progress-bar"
        style="width: {% if panels|length > 1 %}{{ (1 / panels|length * 100)|round }}%{% else %}100%{% endif %}"></div>
    </div>
    <button class="cv-nav-btn" id="cv-next" aria-label="Next page" {% if panels|length <=1 %}disabled{% endif %}>Next
      →</button>
  </div>

  {% else %}
  <p style="color: var(--text-muted); margin: 2rem 0;">No evidence photos available for this chapter.</p>
  {% endif %}

  {# ── Hidden content container ── #}
  <div id="content-container" data-content-id="{{ content.id }}" data-chapter="{{ content.chapter_number }}"
    style="display:none;">
  </div>

  {# ── Last-page contextual hint ── #}
  {% if not is_preview %}
  <div id="cv-hint-banner" style="display:none;" class="cv-hint-banner">
    <span class="cv-hint-icon">&#9632;</span>
    ALL EVIDENCE EXAMINED &mdash;
    {% if content.chapter_number == 3 %}
    Proceed to the Evidence Analysis to close this chapter.
    {% elif content.chapter_number == 4 %}
    Answer the interrogation questions to close this chapter.
    {% elif content.chapter_number == 5 %}
    Cross-reference the call records to close this chapter.
    {% else %}
    Press <strong>SEAL FILE</strong> below to close this chapter.
    {% endif %}
    <span class="cv-hint-icon">&#9632;</span>
  </div>
  {% endif %}

  {# ── Submit area ── #}
  {% if not is_preview %}
  <div class="cv-submit">
    <div id="submit-result" class="mb-3"></div>
    <button id="btn-submit-completed" class="btn btn-completed  me-2" disabled
      title="Read all pages first to seal the file." {% if content.chapter_number==3
      %}data-puzzle-url="{{ url_for('user.puzzle', content_id=content.id) }}" {% endif %} {% if
      content.chapter_number==4 %}data-quiz-url="{{ url_for('user.quiz', content_id=content.id) }}" {% endif %} {% if
      content.chapter_number==5 %}data-callgame-url="{{ url_for('user.callgame', content_id=content.id) }}" {% endif %}
      {% if content.chapter_number==7 %}data-codegate-url="{{ url_for('user.codegate', content_id=content.id) }}" {%
      endif %}>✔ Seal
      File
      (Completed)</button>
    <button id="btn-submit-incomplete" class="btn btn-incomplete">✘ Abandon File (Incomplete)</button>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
  window.CONTENT_ID = {{ content.id }};
  window.CONTENT_CHAPTER = {{ content.chapter_number }};
  window.CONTENT_PANELS = {{ panels | tojson }};
</script>

{% if is_video %}
<script>
  (function () {
    "use strict";

    var VIDEO_TYPE = {{ video_type | tojson
  }};

  function unlockSealFile() {
    var hint = document.getElementById("cv-video-hint");
    if (hint) {
      hint.textContent = "\u2714 Recording complete \u2014 you may now seal the case file.";
      hint.classList.add("done");
    }
    var btnSeal = document.getElementById("btn-submit-completed");
    if (btnSeal) {
      btnSeal.disabled = false;
      btnSeal.title = "";
      if (!btnSeal.classList.contains("seal-ready")) {
        btnSeal.classList.add("seal-ready");
        setTimeout(function () { btnSeal.classList.remove("seal-ready"); }, 3700);
      }
    }
    var hintBanner = document.getElementById("cv-hint-banner");
    if (hintBanner) hintBanner.style.display = "block";
  }

  /* ── Direct video (HTML5) ── */
  var videoEl = document.getElementById("cv-video-el");
  if (videoEl) {
    videoEl.addEventListener("ended", unlockSealFile);
  }

  /* ── YouTube IFrame API ── */
  if (VIDEO_TYPE === "youtube") {
    window.onYouTubeIframeAPIReady = function () {
      var iframe = document.getElementById("cv-video-iframe");
      if (!iframe) return;
      var player = new YT.Player(iframe, {
        events: {
          onStateChange: function (e) {
            if (e.data === YT.PlayerState.ENDED) unlockSealFile();
          }
        }
      });
    };
    /* Load the YouTube IFrame API script */
    var tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
  }

  /* ── Vimeo (postMessage) ── */
  if (VIDEO_TYPE === "vimeo") {
    var iframe = document.getElementById("cv-video-iframe");
    if (iframe) {
      /* Tell the player we want finish events */
      iframe.addEventListener("load", function () {
        iframe.contentWindow.postMessage(
          JSON.stringify({ method: "addEventListener", value: "finish" }), "*"
        );
      });
      window.addEventListener("message", function (e) {
        try {
          var data = JSON.parse(e.data);
          if (data.event === "finish") unlockSealFile();
        } catch (_) { }
      });
    }
  }
}) ();
</script>
{% endif %}

<script>
  (function () {
    "use strict";

    /* ── State ── */
    var panels = document.querySelectorAll(".cv-panel");
    var totalPages = panels.length;
    var curPage = 0;
    var reachedLastPage = (totalPages <= 1);

    /* pan+zoom state */
    var scale = 1, panX = 0, panY = 0;
    var SCALE_MIN = 1, SCALE_MAX = 5;

    /* ── Element refs ── */
    var btnPrev = document.getElementById("cv-prev");
    var btnNext = document.getElementById("cv-next");
    var counter = document.getElementById("cv-page-counter");
    var progressBar = document.getElementById("cv-progress-bar");
    var progressWrap = document.getElementById("cv-progress-wrap");
    var zoomLabel = document.getElementById("cv-zoom-label");
    var viewport = document.getElementById("cv-viewport");

    if (!panels.length) return;

    /* ── Canvas helper ── */
    function currentCanvas() {
      var p = panels[curPage];
      return p ? p.querySelector(".cv-canvas") : null;
    }

    /* ── Apply pan+zoom transform ── */
    function applyTransform() {
      var c = currentCanvas();
      if (c) c.style.transform = "translate(" + panX.toFixed(1) + "px," + panY.toFixed(1) + "px) scale(" + scale + ")";
      if (zoomLabel) zoomLabel.textContent = Math.round(scale * 100) + "%";
      viewport.style.cursor = (scale > 1) ? "grab" : "default";
      /* Allow page scroll at scale=1; lock to JS handling when zoomed */
      viewport.style.touchAction = scale > 1 ? "none" : "pan-y";
    }

    /* ── Clamp pan inside viewport ── */
    function clampPan() {
      var vw = viewport.offsetWidth;
      var vh = viewport.offsetHeight;
      /* viewport height = natural canvas height (normal-flow canvas).
         Allow vertical pan even at scale=1 for tall images. */
      panX = Math.min(0, Math.max(vw - vw * scale, panX));
      panY = Math.min(0, Math.max(vh - vh * scale, panY));
      if (scale <= 1) panX = 0; /* image always fills width, so no horizontal pan */
    }

    /* ── Zoom at viewport-relative point (cx, cy) ── */
    function zoomAt(cx, cy, factor) {
      var newScale = Math.min(SCALE_MAX, Math.max(SCALE_MIN, scale * factor));
      var f = newScale / scale;
      panX = cx - (cx - panX) * f;
      panY = cy - (cy - panY) * f;
      scale = newScale;
      clampPan();
      applyTransform();
    }

    /* ── Reset to fit ── */
    function resetView() {
      scale = 1; panX = 0; panY = 0;
      applyTransform();
    }

    /* ── Navigate pages ── */
    function goTo(idx) {
      if (idx < 0 || idx >= totalPages) return;
      resetView();
      panels[curPage].classList.remove("active");
      curPage = idx;
      panels[curPage].classList.add("active");

      counter.textContent = "Page " + (curPage + 1) + " / " + totalPages;
      var pct = ((curPage + 1) / totalPages) * 100;
      progressBar.style.width = pct + "%";
      if (progressWrap) progressWrap.setAttribute("aria-valuenow", curPage + 1);

      btnPrev.disabled = (curPage === 0);
      btnNext.disabled = (curPage === totalPages - 1);

      if (curPage === totalPages - 1) reachedLastPage = true;
      var btnSeal = document.getElementById("btn-submit-completed");
      if (btnSeal) {
        btnSeal.disabled = !reachedLastPage;
        btnSeal.title = reachedLastPage ? "" : "Read all pages first to seal the file.";
      }

      if (curPage === totalPages - 1) {
        var hintBanner = document.getElementById("cv-hint-banner");
        if (hintBanner && hintBanner.style.display === "none") hintBanner.style.display = "block";
        if (btnSeal && !btnSeal.classList.contains("seal-ready")) {
          btnSeal.classList.add("seal-ready");
          setTimeout(function () { btnSeal.classList.remove("seal-ready"); }, 3700);
        }
      }

      applyTransform();
    }

    /* ════════════════════════════════════════
       WHEEL — zoom at cursor
    ════════════════════════════════════════ */
    viewport.addEventListener("wheel", function (e) {
      e.preventDefault();
      var rect = viewport.getBoundingClientRect();
      var factor = e.deltaY < 0 ? 1.15 : 1 / 1.15;
      zoomAt(e.clientX - rect.left, e.clientY - rect.top, factor);
    }, { passive: false });

    /* ════════════════════════════════════════
       MOUSE DRAG — pan while zoomed
    ════════════════════════════════════════ */
    var drag = null;
    viewport.addEventListener("mousedown", function (e) {
      if (e.button !== 0) return;
      drag = { x: e.clientX, y: e.clientY, px: panX, py: panY };
      viewport.style.cursor = "grabbing";
      e.preventDefault();
    });
    document.addEventListener("mousemove", function (e) {
      if (!drag) return;
      panX = drag.px + e.clientX - drag.x;
      panY = drag.py + e.clientY - drag.y;
      clampPan();
      applyTransform();
    });
    document.addEventListener("mouseup", function () {
      if (!drag) return;
      drag = null;
      viewport.style.cursor = scale > 1 ? "grab" : "default";
    });

    /* ════════════════════════════════════════
       DOUBLE-CLICK — zoom in or reset
    ════════════════════════════════════════ */
    viewport.addEventListener("dblclick", function (e) {
      var rect = viewport.getBoundingClientRect();
      if (scale > 1.05) {
        resetView();
      } else {
        zoomAt(e.clientX - rect.left, e.clientY - rect.top, 2.5);
      }
    });

    /* ════════════════════════════════════════
       TOUCH — pinch to zoom + drag to pan
    ════════════════════════════════════════ */
    var touch = null;

    function touchDist(t) {
      var dx = t[0].clientX - t[1].clientX, dy = t[0].clientY - t[1].clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
    function touchMid(t, rect) {
      return {
        x: (t[0].clientX + t[1].clientX) / 2 - rect.left,
        y: (t[0].clientY + t[1].clientY) / 2 - rect.top
      };
    }

    viewport.addEventListener("touchstart", function (e) {
      /* DO NOT call preventDefault here — that blocked all touch interactions.
         We selectively prevent default in touchmove instead. */
      var rect = viewport.getBoundingClientRect();
      if (e.touches.length === 1) {
        touch = { type: "pan", x: e.touches[0].clientX, y: e.touches[0].clientY, px: panX, py: panY };
      } else if (e.touches.length === 2) {
        e.preventDefault(); /* suppress browser pinch on the pinch START gesture */
        touch = {
          type: "pinch",
          dist: touchDist(e.touches),
          mid: touchMid(e.touches, rect),
          s0: scale, px0: panX, py0: panY
        };
      }
    }, { passive: false });

    viewport.addEventListener("touchmove", function (e) {
      if (!touch) return;
      /* Prevent default ONLY for pinch (always) or single-finger pan while zoomed.
         At scale=1 with one finger: let the page scroll naturally. */
      if (e.touches.length >= 2 || (scale > 1 && e.touches.length === 1)) {
        e.preventDefault();
      }
      var rect = viewport.getBoundingClientRect();
      if (e.touches.length === 2 && touch.type === "pinch") {
        var d = touchDist(e.touches);
        var mid = touchMid(e.touches, rect);
        var factor = d / touch.dist;
        var newScale = Math.min(SCALE_MAX, Math.max(SCALE_MIN, touch.s0 * factor));
        var f = newScale / touch.s0;
        scale = newScale;
        panX = touch.mid.x - (touch.mid.x - touch.px0) * f;
        panY = touch.mid.y - (touch.mid.y - touch.py0) * f;
        clampPan();
        applyTransform();
      } else if (e.touches.length === 1 && touch.type === "pan" && scale > 1) {
        panX = touch.px + e.touches[0].clientX - touch.x;
        panY = touch.py + e.touches[0].clientY - touch.y;
        clampPan();
        applyTransform();
      }
    }, { passive: false });

    viewport.addEventListener("touchend", function (e) {
      if (e.touches.length === 0) touch = null;
    }, { passive: true });

    /* ════════════════════════════════════════
       DOUBLE-TAP — zoom in or reset
    ════════════════════════════════════════ */
    var lastTap = { t: 0, x: 0, y: 0 };
    viewport.addEventListener("touchend", function (e) {
      if (e.changedTouches.length !== 1) return;
      var now = Date.now();
      var rect = viewport.getBoundingClientRect();
      var cx = e.changedTouches[0].clientX - rect.left;
      var cy = e.changedTouches[0].clientY - rect.top;
      if (now - lastTap.t < 300 && Math.abs(cx - lastTap.x) < 35 && Math.abs(cy - lastTap.y) < 35) {
        scale > 1.05 ? resetView() : zoomAt(cx, cy, 2.5);
        lastTap.t = 0;
      } else {
        lastTap = { t: now, x: cx, y: cy };
      }
    }, { passive: true });

    /* ════════════════════════════════════════
       KEYBOARD
    ════════════════════════════════════════ */
    document.addEventListener("keydown", function (e) {
      if (e.key === "ArrowRight" || e.key === "ArrowDown") goTo(curPage + 1);
      if (e.key === "ArrowLeft" || e.key === "ArrowUp") goTo(curPage - 1);
      if (e.key === "0" || e.key === "Escape") resetView();
      var midX = viewport.offsetWidth / 2;
      var midY = viewport.offsetHeight / 2;
      if (e.key === "+" || e.key === "=") zoomAt(midX, midY, 1.25);
      if (e.key === "-") zoomAt(midX, midY, 0.8);
    });

    /* ── Nav buttons ── */
    if (btnPrev) btnPrev.addEventListener("click", function () { goTo(curPage - 1); });
    if (btnNext) btnNext.addEventListener("click", function () { goTo(curPage + 1); });

    /* ── Init ── */
    goTo(0);

  })();

</script>

<script>
  // Load optional per-chapter JS (timer etc) and submit handlers
  document.addEventListener("DOMContentLoaded", function () {
    var container = document.getElementById("content-container");
    var contentId = container && container.getAttribute("data-content-id");
    if (contentId) {
      var script = document.createElement("script");
      script.src = "{{ url_for('static', filename='contents') }}/content_" + contentId + ".js";
      script.async = true;
      document.body.appendChild(script);
    }
    window.ChallengeHost && window.ChallengeHost.attachContentHandlers();
  });
</script>
{% endblock %}